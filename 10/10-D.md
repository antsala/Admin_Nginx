# Directivas de Nginx.


Nginx tiene  tres módulos base:

- `Módulo Core`: Funciones esenciales y directivas, como gestión de procesos y seguridad.
- `Módulo Events`: Permite configurar los mecanismos internos de las capacidades de red.
- `Módulo Configuration`: Habilita el mecanismo de inclusión.

Antes de comenzar a detallar las directivas de configuración, es necesario comprender la arquitectura general de procesos, es decir, cómo funciona el demonio de Nginx. Aunque la aplicación se presenta como un simple archivo binario (y un proceso en segundo plano liviano), la forma en que funciona en tiempo de ejecución puede ser relativamente compleja.

En el momento de iniciar Nginx, existe un único proceso en la memoria: el ***proceso maestro***. Se inicia con los permisos de usuario y grupo actuales, generalmente root/root si el servicio se inicia en el arranque mediante un script de inicio. El proceso maestro en sí mismo no procesa ninguna solicitud de cliente; en su lugar, genera procesos que sí lo hacen: los procesos de trabajo, que se asignan a un usuario y grupo personalizables.

Desde el archivo de configuración, puedes definir la cantidad de procesos de trabajo (workers), las conexiones máximas por proceso de trabajo, el usuario y grupo bajo el cual se ejecutan los procesos de trabajo.

## Directivas del módulo CORE.

- **Directiva `daemon`**:

    Valores aceptados: `on` o `off`.
    Sintaxis: `daemon on;`.
    Valor predeterminado: `on`.
    Habilita o deshabilita el modo demonio (daemon). Si lo deshabilitas, el programa no se iniciará en segundo plano; permanecerá en primer plano cuando se lance desde la terminal. Esto puede ser útil para depurar, en situaciones en las que necesitas saber qué causa que Nginx se bloquee.

- **Directiva `env`**:

    Sintaxis: `env MI_VARIABLE=mi_valor;`.
    Permite definir o redefinir variables de entorno que serán utilizadas posteriormente.

- **Directiva `errorlog`**:

    Sintaxis: `error_log /ruta/del/archivo nivel;`, donde `nivel` es uno de estos valores: `debug`, `info`, `notice`,
`warn`, `error`, `crit`, `alert`, `emerg` (de más detallado a menos detallado)
    Valor predeterminado: `logs/error.log error`. 
    Esta directiva habilita el registro de errores en diferentes niveles: `aplicación`, `servidor HTTP`, `host virtual` y `directorio` de host virtual. 

- **Directiva `load_module`**:
    Sintaxis: `load_module modules/ngx_http_geoip_module.so;`
    Carga un módulo compilado dinámicamente en tiempo de ejecución. Los módulos serán tratados detalladamente más adelante.

- **Directiva `pid`**:

    Sintaxis: `pid logs/nginx.pid;`.
    Ruta del `archivo pid` para el demonio de Nginx. Debemos asegurarnos de habilitar esta directiva y configurar su valor adecuadamente, ya que el archivo pid es usado por el script `init` de Nginx.

- **Directiva `ssl_engine`**:

    Sintaxis: `ssl_engine nombre_del_motor;`.
    `nombre_del_motor` es el nombre de un acelerador SSL de hardware disponible en tu sistema. Para verificar los aceleradores SSL de hardware disponibles, ejecuta este comando desde la terminal: `openssl engine -t`

- **Directiva `user`**:

    Sintaxis: `user nombre_de_usuario nombre_de_grupo;` o `user nombre_de_usuario;`.
    Si la directiva no está definida, se utilizan el usuario y el grupo del proceso maestro de Nginx. Permite definir la cuenta de usuario, y opcionalmente, el grupo de usuario utilizado para iniciar los procesos workers de Nginx. Por razones de seguridad, es muy recomendable especificar un usuario y grupo con privilegios limitados. Por ejemplo, crear un nuevo usuario y grupo dedicado a Nginx, al que aplicamos los permisos adecuados.

- **Directiva `worker_cpu_affinity`**:

    Sintaxis: `worker_cpu_affinity 1000 0100 0010 0001;` o `worker_cpu_affinity 10 10 01 01;` o `worker_cpu_affinity auto;`.

    Esta directiva funciona en conjunto con `worker_processes`. Nos permite asignar procesos workers a núcleos de CPU.Hay tantas series de bloques de dígitos como procesos trabajadores. Hay tantos dígitos en un bloque como núcleos tenga tu CPU. Si configuramos Nginx para usar tres procesos workers, tendremos tres bloques de dígitos. Para una CPU de doble núcleo, cada bloque tiene dos dígitos: `worker_cpu_affinity 01 01 10;` tenemos que, el primer bloque `(01)` indica que el primer proceso worker debe ser asignado al segundo núcleo. El segundo bloque `(01)` indica que el segundo proceso worker debe ser asignado al segundo núcleo. El tercer bloque `(10)` indica que el tercer proceso worker debe ser asignado al primer núcleo.
    
    El valor `auto` permite que Nginx administre automáticamente la asignación de procesos. Si no establecemos esta sirectiva, el sistema operativo lo gestionará. Debemos tener en cuenta que la afinidad solo se recomienda para CPUs multinúcleo, y no para procesadores con hiperthreading u tecnologías similares.

- **Directiva `worker_processes`**:

    Sintaxis: `worker_processes 4;`.

    Define la cantidad de procesos workers. Nginx ofrece separar el tratamiento de las solicitudes en varios procesos. El valor predeterminado es `1`, pero se recomienda aumentar este valor si la CPU tiene más de un núcleo. Además, si un proceso se bloquea debido a operaciones de E/S lentas, las solicitudes entrantes pueden ser delegadas a los otros procesos workers. Alternativamente, podemos usar el valor `auto`, que permitirá que Nginx seleccione un valor apropiado para esta directiva. Por defecto, es la cantidad de núcleos de CPU detectados en el sistema.



[Vamos al siguiente contenido](./10-E.md)